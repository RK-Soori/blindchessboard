<!DOCTYPE html>
<html>
<head>
    <title>Realtime Chess - Synchronized</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; gap: 40px; padding: 30px; background-color: #f0f2f5; }
        .container { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        #boardContainer { width: 400px; }
        #moveInput { padding: 12px; width: 150px; border: 1px solid #ced4da; border-radius: 8px; }
        button { padding: 12px 20px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 8px; }
        button:hover { background-color: #218838; }
        #moveHistory { max-height: 350px; overflow-y: auto; list-style: none; padding: 0; width: 300px; background: #fafafa; border: 1px solid #ddd; }
        #moveHistory li { padding: 8px 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Realtime Chess</h2>
        <div id="boardContainer"></div>
        <div style="margin-top: 20px;">
            <button onclick="startNewGame()" style="background-color: #dc3545;">Start New Game (Reset DB)</button>
        </div>
    </div>

    <div class="container">
        <h2 id="turnIndicator">Loading...</h2>
        <div>
            <input type="text" id="moveInput" placeholder="e2e4">
            <button onclick="recordMoveFromInput()">Submit Move</button>
            <p id="statusMessage" style="color:red; height: 20px;"></p>
        </div>
        <h3>Move History</h3>
        <ul id="moveHistory"></ul>
    </div>

    <script>
        // *****************************************************************
        // CONFIGURATION
        // *****************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA7CXPxD3GxvO3Fge6GV-85T_3Wjf840Rw",
            authDomain: "reattime-dba.firebaseapp.com",
            databaseURL: "https://reattime-dba-default-rtdb.firebaseio.com",
            projectId: "reattime-dba",
            storageBucket: "reattime-dba.firebasestorage.app",
            messagingSenderId: "526454581643",
            appId: "1:526454581643:web:a6f8ddeccef69ec42d278e"
        };
        // *****************************************************************

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const gameRef = database.ref('chess_game');
        const movesRef = database.ref('chess_game/moves');

        let game = new Chess();
        let board = null;

        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
        }

        function onDrop(source, target) {
            let moveCfg = { from: source, to: target, promotion: 'q' };
            let tempGame = new Chess(game.fen());
            let move = tempGame.move(moveCfg);
            if (move === null) return 'snapback';
            saveMoveToFirebase(source + target); 
        }

        function recordMoveFromInput() {
            const m = document.getElementById('moveInput').value.trim();
            if(m) saveMoveToFirebase(m);
        }

        function saveMoveToFirebase(moveString) {
            const moveResult = game.move(moveString, { sloppy: true });
            if (moveResult === null) {
                document.getElementById('statusMessage').textContent = "Invalid move!";
                return;
            }
            game.undo(); // Undo locally, let the listener update the board

            movesRef.once('value').then(snapshot => {
                const moves = snapshot.val();
                let nextIndex = 1;
                
                // Calculate next index based on array size
                // We use Anchor at 0, so length is reliable
                if (Array.isArray(moves)) {
                    nextIndex = moves.length; 
                } else if (moves && typeof moves === 'object') {
                    const keys = Object.keys(moves).map(Number).filter(n => !isNaN(n));
                    if (keys.length > 0) nextIndex = Math.max(...keys) + 1;
                }

                const formattedMove = moveResult.from + moveResult.to; 
                const updateData = {};
                
                // Save to moves/1, moves/2...
                updateData[`chess_game/moves/${nextIndex}`] = {
                    move: formattedMove,
                    player: moveResult.color === 'w' ? 'White' : 'Black',
                    fen: moveResult.after,
                    source: "WEB_CLIENT",
                    timestamp: Date.now()
                };
                updateData['chess_game/fen'] = moveResult.after;

                database.ref().update(updateData).catch(console.error);
                document.getElementById('moveInput').value = '';
                document.getElementById('statusMessage').textContent = '';
            });
        }

        function startNewGame() {
            if(confirm("Start new game? This resets the board.")) {
                // Initialize with Anchor at 0
                database.ref('chess_game').set({
                    fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
                    moves: {
                        0: { status: "Game Started", timestamp: Date.now() }
                    }
                });
            }
        }

        function updateUI(fen, moves) {
            // Re-sync game logic
            if (fen && (fen.includes("updated_by") || fen.includes("esp_32"))) {
                game.reset();
                if (moves) {
                    const keys = Object.keys(moves).sort((a,b) => Number(a)-Number(b));
                    keys.forEach(k => {
                        if (k == 0 || !moves[k].move) return;
                        game.move(moves[k].move, {sloppy: true});
                    });
                }
            } else {
                game.load(fen);
            }

            board.position(game.fen());
            
            const turn = game.turn() === 'w' ? "White" : "Black";
            document.getElementById('turnIndicator').textContent = `${turn} to Move`;
            
            const historyEl = document.getElementById('moveHistory');
            historyEl.innerHTML = '';
            
            if (moves) {
                const moveKeys = Object.keys(moves).sort((a,b) => Number(a)-Number(b));
                moveKeys.forEach(key => {
                    if (key == 0 || !moves[key].move) return; // Skip Anchor

                    const m = moves[key];
                    let li = document.createElement('li');
                    li.innerHTML = `<b>${key}.</b> ${m.player} <small>(${m.source})</small>: ${m.move}`;
                    historyEl.appendChild(li);
                });
            }
        }

        // --- LISTENER ---
        gameRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const fen = data.fen || 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
                const moves = data.moves || null;
                updateUI(fen, moves);
            }
        });

        $(document).ready(function() {
            board = Chessboard('boardContainer', {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                pieceTheme: 'img/pieces/{piece}.png'
            });
        });
    </script>
</body>
</html>

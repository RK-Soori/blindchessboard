<!DOCTYPE html>
<html>
<head>
    <title>Realtime Chess (Auto-Sync)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; gap: 40px; padding: 30px; background-color: #f0f2f5; }
        .container { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        #boardContainer { width: 400px; }
        #moveInput { padding: 12px; width: 150px; border: 1px solid #ced4da; border-radius: 8px; }
        button { padding: 12px 20px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 8px; }
        button:hover { background-color: #218838; }
        #controls button { background-color: #dc3545; }
        #moveHistory { max-height: 350px; overflow-y: auto; list-style: none; padding: 0; width: 300px; background: #fafafa; border: 1px solid #ddd; }
        #moveHistory li { padding: 8px 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Realtime Chess</h2>
        <div id="boardContainer"></div>
        <div id="controls" style="margin-top: 20px;">
            <button onclick="startNewGame()">Start New Game (Reset DB)</button>
        </div>
    </div>

    <div class="container">
        <h2 id="turnIndicator">Loading...</h2>
        <div>
            <input type="text" id="moveInput" placeholder="e2e4">
            <button onclick="recordMoveFromInput()">Submit Move</button>
            <p id="statusMessage" style="color:red; height: 20px;"></p>
        </div>
        <h3>Move History</h3>
        <ul id="moveHistory"></ul>
    </div>

    <script>
        // *****************************************************************
        // CONFIGURATION
        // *****************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA7CXPxD3GxvO3Fge6GV-85T_3Wjf840Rw",
            authDomain: "reattime-dba.firebaseapp.com",
            databaseURL: "https://reattime-dba-default-rtdb.firebaseio.com",
            projectId: "reattime-dba",
            storageBucket: "reattime-dba.firebasestorage.app",
            messagingSenderId: "526454581643",
            appId: "1:526454581643:web:a6f8ddeccef69ec42d278e"
        };
        // *****************************************************************

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const gameRef = database.ref('chess_game');
        const movesRef = database.ref('chess_game/moves');

        let game = new Chess();
        let board = null;
        let lastMoveCount = 0; 

        // Audio Logic
        const pieceNames = { 'p': 'pawn', 'n': 'knight', 'b': 'bishop', 'r': 'rook', 'q': 'queen', 'k': 'king' };
        
        function playNextSound(soundPaths) {
            if (soundPaths.length === 0) return;
            const path = soundPaths.shift();
            const audio = new Audio(path);
            audio.playbackRate = 1.2;
            audio.onended = () => playNextSound(soundPaths);
            audio.play().catch(e => playNextSound(soundPaths));
        }

        function speakMove(moveResult) {
            const baseDir = 'Chess_board_audio/';
            const piece = pieceNames[moveResult.piece];
            const color = (moveResult.color === 'w') ? 'white' : 'black';
            const dest = moveResult.to;
            let seq = [
                `${baseDir}color/${color}.mp3`,
                `${baseDir}piece/${piece}.mp3`,
                `${baseDir}position/letter/${dest[0]}.mp3`,
                `${baseDir}position/number/${dest[1]}.mp3`
            ];
            if (moveResult.captured) seq.splice(2, 0, `${baseDir}action/takes.mp3`);
            if (moveResult.san.includes('#')) seq.push(`${baseDir}action/checkmate.mp3`);
            else if (moveResult.san.includes('+')) seq.push(`${baseDir}action/check.mp3`);
            playNextSound(seq);
        }

        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
        }

        function onDrop(source, target) {
            let moveCfg = { from: source, to: target, promotion: 'q' };
            let tempGame = new Chess(game.fen());
            let move = tempGame.move(moveCfg);
            if (move === null) return 'snapback';
            saveMoveToFirebase(source + target); 
        }

        function recordMoveFromInput() {
            const m = document.getElementById('moveInput').value.trim();
            if(m) saveMoveToFirebase(m);
        }

        function saveMoveToFirebase(moveString) {
            const moveResult = game.move(moveString, { sloppy: true });
            if (moveResult === null) {
                document.getElementById('statusMessage').textContent = "Invalid move!";
                return;
            }
            game.undo(); // Undo locally, wait for DB sync

            movesRef.once('value').then(snapshot => {
                const moves = snapshot.val() || {};
                
                // LOGIC: Find next available index (1, 2, 3...)
                let nextIndex = 1;
                if (moves && typeof moves === 'object') {
                    // Filter numeric keys and find max
                    const keys = Object.keys(moves).map(Number).filter(n => !isNaN(n));
                    if (keys.length > 0) nextIndex = Math.max(...keys) + 1;
                } else if (Array.isArray(moves)) {
                    nextIndex = moves.length; // Array length is usually the next index
                }

                const formattedMove = moveResult.from + moveResult.to; 
                
                // Write to database
                const updates = {};
                updates[`chess_game/moves/${nextIndex}`] = {
                    move: formattedMove,
                    player: moveResult.color === 'w' ? 'White' : 'Black',
                    fen: moveResult.after,
                    timestamp: Date.now()
                };
                updates['chess_game/fen'] = moveResult.after;

                database.ref().update(updates).catch(console.error);
                document.getElementById('moveInput').value = '';
                document.getElementById('statusMessage').textContent = '';
            });
        }

        function startNewGame() {
            if(confirm("Start new game?")) {
                database.ref('chess_game').set({
                    fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
                    moves: null 
                });
            }
        }

        function updateUI(fen, moves) {
            game.load(fen);
            board.position(fen);
            
            const turn = game.turn() === 'w' ? "White" : "Black";
            document.getElementById('turnIndicator').textContent = `${turn} to Move`;
            
            const historyEl = document.getElementById('moveHistory');
            historyEl.innerHTML = '';
            
            if (moves) {
                // Ensure we handle both Array and Object responses from Firebase
                const moveKeys = Object.keys(moves).sort((a,b) => Number(a)-Number(b));
                let validMoveCount = 0;

                moveKeys.forEach(key => {
                    if (key === '0' || !moves[key]) return; // Skip 0 or nulls

                    const m = moves[key];
                    let li = document.createElement('li');
                    li.innerHTML = `<b>${key}.</b> ${m.player}: ${m.move}`;
                    historyEl.appendChild(li);
                    validMoveCount++;
                });

                // Audio Trigger
                if (validMoveCount > lastMoveCount) {
                    // Play audio logic (simplified for reliability)
                    let tempGame = new Chess();
                    let moveRes = null;
                    moveKeys.forEach(k => {
                        if(k !== '0' && moves[k]) moveRes = tempGame.move(moves[k].move, {sloppy:true});
                    });
                    if(moveRes) speakMove(moveRes);
                    lastMoveCount = validMoveCount;
                }
            } else {
                lastMoveCount = 0;
            }
        }

        gameRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const fen = data.fen || 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
                const moves = data.moves || null;
                updateUI(fen, moves);
            }
        });

        $(document).ready(function() {
            board = Chessboard('boardContainer', {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                pieceTheme: 'img/pieces/{piece}.png'
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Full Realtime Drag-and-Drop Chess Game with Audio</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /*
         * GLOBAL STYLES
         */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modern Font Stack */
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            gap: 40px; /* Increased spacing */
            padding: 30px; 
            background-color: #f0f2f5; /* Light, soft background */
            color: #333; /* Darker text */
        }
        
        /* Main Content Boxes */
        .container { 
            display: flex; 
            flex-direction: column; 
            background: #ffffff;
            padding: 30px; /* Increased padding */
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* Softer, deeper shadow */
            border: 1px solid #e0e0e0; /* Subtle border */
        }

        h2 {
            font-weight: 600;
            color: #007bff;
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #eeeeee;
        }

        /* Chessboard Specific */
        #boardContainer { 
            width: 400px; 
            max-width: 100%; 
        }

        /*
         * INPUTS AND BUTTONS
         */
        #controls { margin-top: 25px; }
        
        #moveInput { 
            padding: 12px; /* Larger padding */
            font-size: 16px; 
            width: 150px; 
            border: 1px solid #ced4da; 
            border-radius: 8px; /* More rounded */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #moveInput:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

        button { 
            padding: 12px 20px; 
            font-size: 16px; 
            cursor: pointer;
            background-color: #28a745; /* Green for action buttons */
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover { 
            background-color: #218838; 
            transform: translateY(-1px); /* Little lift effect */
        }

        #controls button {
            background-color: #dc3545; /* Red for reset action */
        }
        #controls button:hover {
            background-color: #c82333;
        }

        /*
         * STATUS AND HISTORY
         */
        #turnIndicator { 
            margin-top: 0; 
            padding-bottom: 15px; 
            border-bottom: 2px solid #007bff; /* Highlight the turn */
            font-weight: 700;
            color: #333;
        }
        
        .message { 
            color: #dc3545; 
            font-weight: 600; 
            margin-top: 15px; 
            font-size: 0.9em;
        }

        h3 {
            margin-top: 25px;
            color: #555;
            font-weight: 600;
        }

        #moveHistory { 
            list-style: none; /* Remove default list style */
            padding: 10px; 
            max-height: 350px; 
            overflow-y: auto; 
            border: 1px solid #ced4da; 
            width: 300px; 
            margin-top: 10px; 
            border-radius: 8px;
            background-color: #fafafa;
            counter-reset: move-counter; /* Initialize counter */
        }
        #moveHistory li { 
            padding: 8px 10px; 
            border-bottom: 1px solid #e9ecef; 
            font-size: 15px; 
            position: relative;
            margin-left: 30px; /* Space for the custom number */
        }
        #moveHistory li:before {
            counter-increment: move-counter;
            content: counter(move-counter) ". "; /* Custom list numbers */
            position: absolute;
            left: -30px;
            font-weight: bold;
            color: #007bff;
        }
        #moveHistory li:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Realtime Chess</h2>
        <div id="boardContainer">
            </div>

        <div id="controls">
            <button onclick="startNewGame()">Start New Game (Reset DB)</button>
        </div>
    </div>

    <div class="container">
        <h2 id="turnIndicator">...</h2>

        <div>
            <input type="text" id="moveInput" placeholder="e2e4 / g1f3">
            <button onclick="recordMoveFromInput()">Submit Move</button>
            <p id="statusMessage" class="message"></p>
        </div>
        
        <h3>Move History:</h3>
        <ol id="moveHistory"></ol>
    </div>

    <script>
        // *****************************************************************
        // STEP 1: REPLACE THIS WITH YOUR ACTUAL CONFIGURATION
        // *****************************************************************
        const firebaseConfig = {
  apiKey: "AIzaSyA7CXPxD3GxvO3Fge6GV-85T_3Wjf840Rw",
  authDomain: "reattime-dba.firebaseapp.com",
  databaseURL: "https://reattime-dba-default-rtdb.firebaseio.com",
  projectId: "reattime-dba",
  storageBucket: "reattime-dba.firebasestorage.app",
  messagingSenderId: "526454581643",
  appId: "1:526454581643:web:a6f8ddeccef69ec42d278e",
  measurementId: "G-1NCZKB5L3B"
};
        // *****************************************************************

        // ------------------ GLOBAL GAME & FIREBASE VARIABLES ------------------
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const gameRef = database.ref('chess_game');
        const fenRef = database.ref('chess_game/fen'); 
        const movesRef = database.ref('chess_game/moves'); 

        let game = new Chess(); 
        let board = null;       
        const START_FEN = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
        
        // Map chess.js piece letters to full names for audio
        const pieceNames = {
            'p': 'pawn',
            'n': 'knight',
            'b': 'bishop',
            'r': 'rook',
            'q': 'queen',
            'k': 'king'
        };
        
        // ** NEW CONSTANT FOR AUDIO SPEED **
        const AUDIO_PLAYBACK_RATE = 1.2;

        // ------------------ AUDIO HANDLING ------------------
        
        /**
         * Plays the next sound in a sequence recursively.
         * @param {string[]} soundPaths - Array of relative paths to MP3 files.
         */
        function playNextSound(soundPaths) {
            if (soundPaths.length === 0) {
                return;
            }

            const path = soundPaths.shift(); // Get the first path and remove it
            const audio = new Audio(path);
            
            // ** THE FIX: Speed up the playback **
            audio.playbackRate = AUDIO_PLAYBACK_RATE;
            
            // Set up listener to play the next sound after the current one finishes
            audio.onended = () => {
                playNextSound(soundPaths);
            };

            // Start playing
            audio.play().catch(error => {
                console.warn(`Audio error: Could not play ${path}. Check file path/existence or browser autoplay restrictions.`, error);
                // Continue to the next sound even if one fails
                playNextSound(soundPaths);
            });
        }
        
        /**
         * Generates and plays the audio sequence for a completed move.
         * @param {object} moveResult - The result object from chess.js move().
         */
        function speakMove(moveResult) {
            // Determine piece name, color, and destination square
            const pieceCode = moveResult.piece; // p, n, b, r, q, k
            const piece = pieceNames[pieceCode];
            const color = (moveResult.color === 'w') ? 'white' : 'black';
            const destSquare = moveResult.to; // e.g., 'e4'
            const letter = destSquare[0];
            const number = destSquare[1];
            
            // Base directory for audio files
            const baseDir = 'Chess_board_audio/';
            
            // Construct the sequence of file paths
            const audioSequence = [
                `${baseDir}color/${color}.mp3`,
                `${baseDir}piece/${piece}.mp3`,
                // Optionally add a transition or "to" word here if desired
                `${baseDir}position/letter/${letter}.mp3`,
                `${baseDir}position/number/${number}.mp3`
            ];
            
            // Handle special cases
            if (moveResult.captured) {
                // If a piece was captured, insert an "x" or "takes" audio clip
                audioSequence.splice(2, 0, `${baseDir}action/takes.mp3`); 
            }
            if (moveResult.san.includes('#')) {
                audioSequence.push(`${baseDir}action/checkmate.mp3`);
            } else if (moveResult.san.includes('+')) {
                 audioSequence.push(`${baseDir}action/check.mp3`);
            }

            // Play the constructed sequence
            playNextSound(audioSequence);
        }

        // ------------------ CORE MOVE PROCESSING FUNCTION ------------------
        
        function processMove(moveString) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = ''; 

            let tempGame = new Chess(game.fen());
            
            const moveResult = tempGame.move(moveString, { sloppy: true });

            if (moveResult === null) {
                statusElement.textContent = `Invalid move: "${moveString}". Check the rules, format (e.g., e2e4), or if it's the wrong turn.`;
                return null;
            }
            
            // Speak the move before updating the DB
            speakMove(moveResult); 

            const playerColor = (game.turn() === 'w') ? 'White' : 'Black'; 

            fenRef.set(tempGame.fen())
                .then(() => {
                    statusElement.textContent = `Move recorded: ${moveResult.san}`;
                })
                .catch((error) => {
                    console.error("Error updating FEN:", error);
                });
            
            movesRef.push({
                player: playerColor,
                move: moveResult.san,
                fen: tempGame.fen(),
                timestamp: Date.now()
            });

            return moveResult.san;
        }

        // ------------------ DRAG-AND-DROP HANDLERS ------------------
        
        function onDragStart (source, piece, position, orientation) {
            if (piece.search(game.turn() === 'w' ? /^b/ : /^w/) !== -1) {
                return false
            }
        }

        function onDrop (source, target) {
            // Simple pawn promotion fix: assumes Queen promotion
            let moveString = source + target;
            const piece = game.get(source);

            if (piece && piece.type === 'p' && (target[1] === '8' || target[1] === '1')) {
                moveString += 'q'; 
            }

            const result = processMove(moveString);

            if (result === null) {
                return 'snapback';
            }
        }

        function onSnapEnd () {
            // Board sync handled by Firebase listener
        }


        // ------------------ MANUAL INPUT HANDLER ------------------

        function recordMoveFromInput() {
            const moveText = document.getElementById('moveInput').value.trim();
            if (moveText === "") return;

            const result = processMove(moveText);
            
            if (result !== null) {
                document.getElementById('moveInput').value = ''; 
            }
        }

        // ------------------ FIREBASE CONTROL FUNCTIONS ------------------

        function startNewGame() {
            if (confirm("Are you sure you want to start a new game? This will wipe ALL current game data.")) {
                gameRef.set(null)
                    .then(() => {
                        console.log("Game successfully reset in Firebase.");
                        document.getElementById('statusMessage').textContent = "New game started! White to move.";
                    })
                    .catch((error) => {
                        console.error("Error resetting game:", error);
                    });
            }
        }

        function updateMoveHistory(movesData) {
            const historyElement = document.getElementById('moveHistory');
            historyElement.innerHTML = ''; 
            let fullMoveNumber = 0; 
            
            if (!movesData) return;
            
            Object.values(movesData).forEach(moveData => {
                if (moveData.player === 'White') {
                    fullMoveNumber++;
                    const newListItem = document.createElement('li');
                    newListItem.textContent = `${moveData.move}`;
                    newListItem.classList.add('white-move');
                    historyElement.appendChild(newListItem);
                } else {
                    if (historyElement.lastChild) {
                        historyElement.lastChild.textContent += ` ${moveData.move}`;
                    } else {
                        const newListItem = document.createElement('li');
                        newListItem.textContent = `... ${moveData.move}`;
                        historyElement.appendChild(newListItem);
                    }
                }
            });
            
            historyElement.scrollTop = historyElement.scrollHeight;
        }


        // ------------------ INITIALIZATION AND SYNCHRONIZATION ------------------
        
        function initBoard() {
            const PIECE_THEME_PATH = 'img/pieces/{piece}.png';
            
            const cfg = {
                draggable: true,
                position: START_FEN,
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                dropOffBoard: 'snapback',
                pieceTheme: PIECE_THEME_PATH 
            };
            board = Chessboard('boardContainer', cfg);
        }
        
        /**
         * Main listener: Synchronizes the board state (FEN) and game logic for ALL clients.
         */
        gameRef.on('value', (snapshot) => {
            const gameData = snapshot.val();
            
            const fen = (gameData && gameData.fen) ? gameData.fen : START_FEN;
            const moves = (gameData && gameData.moves) ? gameData.moves : null;

            game.load(fen); 

            board.position(fen, false); 

            const turn = (game.turn() === 'w') ? 'White' : 'Black';
            const turnIndicator = document.getElementById('turnIndicator');
            
            if (game.in_checkmate()) {
                turnIndicator.textContent = `Checkmate! ${turn === 'White' ? 'Black' : 'White'} wins!`;
            } else if (game.in_draw() || game.game_over()) {
                turnIndicator.textContent = `Game Over: Draw.`;
            } else {
                turnIndicator.textContent = `${turn} to move.`;
            }
            
            updateMoveHistory(moves);
        });

        // ------------------ Run Initialization ------------------
        $(document).ready(function() {
            initBoard();
        });
    </script>
</body>
</html>
